# Flowise — AgentFlow V2 чат-бота ЦЭСИ

**Важно:** Мы работаем **не в Chatflow**, а в **AgentFlow V2**.  
Все ноды, правила и структура потока берутся **только из AgentFlow V2**.

Этот документ фиксирует **структуру и принципы настройки AgentFlow V2 в Flowise**  
для чат-бота клиники ЦЭСИ.

Он нужен, чтобы:
- можно было **повторно развернуть** тот же поток в новом инстансе Flowise
- понимать, **что именно лежит внутри Flowise**, не открывая UI
- не путать **архитектуру системы** (`bot.md`) с **конкретной конфигурацией AgentFlow V2**

> Вся общая архитектура (VPS, Docker, nginx, backend, виджет) описана в `bot.md`.  
> Здесь — только то, что относится к Flowise.

---

## 1. Роль Flowise в архитектуре

Flowise используется **только как мозг бота** (логика диалога):

- ведёт диалог с пользователем через Prediction API
- применяет системный промпт и developer-правила
- при необходимости использует RAG по markdown-базе
- возвращает **JSON-ответ по схеме Structured Output** (см. `cta.md`, `prompt.md`, `backlog.md`)

Flowise **не**:
- вызывает backend заявок
- отправляет e‑mail или пишет в CRM / Telegram
- управляет интерфейсом виджета

Все внешние действия (кнопки, формы, отправка заявок) выполняет **виджет + backend**,  
а Flowise только **рекомендует следующий шаг** и описывает состояние диалога в JSON.

---

## 2. Базовый поток AgentFlow V2 (MVP / P0)

В P0 используется **один основной AgentFlow V2**, который:

1. Принимает сообщения пользователя (через Prediction API / `/api/*` за nginx, см. `bot.md`).
2. Применяет **системный промпт** из `prompt.md` и **developer‑правила** из `rules.md`.
3. При необходимости обращается к базе знаний (RAG по markdown-файлам).
4. Формирует ответ в формате **Structured Output JSON**:
   - текст ответа пользователю
   - минимальный набор служебных полей для CTA и записи (P0)
5. Возвращает JSON фронту, который уже решает:
   - показывать ли CTA
   - когда переходить к сбору контактов
   - когда отправлять заявку на backend

### 2.1. Структура нод (укрупнённо)

Укрупнённая схема потока в AgentFlow V2 (все ноды — только из AgentFlow V2):

1. **Start / входная нода чата** (AgentFlow V2)  
   - Принимает сообщение пользователя и контекст сессии.

2. **Retriever (RAG)** — ноды AgentFlow V2  
   - Искать по markdown‑базе клиники (и, при необходимости, по Chroma).
   - Ноды загрузки документов и векторного поиска **не описываются как сценарии**,  
     а используются только для фактов (см. `logic.md` про приоритет базы знаний).

3. **LLM‑нода с системным промптом + Structured Output** (AgentFlow V2)  
   - В системный промпт зашиты:
     - бизнес‑цель и роль бота (см. `prompt.md`)
     - developer‑ограничения (см. `rules.md`)
     - правила CTA и записи (ссылки на `cta.md`, `logic.md`)
   - LLM возвращает ответ **строго в формате JSON Structured Output** (см. `prompt.md` §14, `cta.md`).
   - Отдельной «выходной ноды» нет: этот JSON и есть результат потока; он уходит на фронт через Prediction API, дальше — виджет (парсинг, CTA, заявки).

### 2.2. Ограничения P0 по JSON‑ответу

В P0 используется **минимальная схема Structured Output**:

- `answer` — текст ответа пользователю
- `ui.ctaIntent` — намерение по CTA (например, запись)
- `meta.stage` — стадия воронки (например, `ready`)
- `meta.confidence` — уверенность модели в оценке
- `flags.emotional` — эмоциональное состояние / «горячесть» диалога

Полная и расширенная схема (P1+) описана в `cta.md` и в соответствующем разделе `prompt.md`.  
При расхождениях по полям или названиям **источником истины являются `cta.md` и `prompt.md`**.

---

## 3. Принципы настройки Flowise (AgentFlow V2)

Эти правила обязательны при работе с AgentFlow V2:

1. **Flowise не знает про backend**
   - Никаких HTTP‑нод отправки заявок.
   - Flowise не вызывает `/api/send-lead` и любые другие API клиники.

2. **Только Prediction API для диалога**
   - Взаимодействие фронта с ботом идёт через Prediction API (см. `bot.md`).
   - AgentFlow V2 не должен завязываться на конкретные URL nginx — это уровень инфраструктуры.

3. **Structured Output — единый контракт**
   - Любые дополнительные флаги, поля и statе для CTA/лида сначала фиксируются в `cta.md`/`prompt.md`,
     и только потом добавляются в схему Structured Output в Flowise.
   - Фронт и backend не читают «сырые» промпты, а ориентируются только на JSON‑контракт.

4. **RAG — только для фактов**
   - Markdown‑база используется только как база знаний.
   - Никаких «сценариев» в документах; сценарий задаётся промптом и правилами (см. `logic.md`).

5. **Версионность и бэкапы**
   - Не использовать `flowise:latest` без фиксации версии (см. рекомендации в `bot.md`).
   - Делать бэкап `database.sqlite` перед крупными изменениями AgentFlow V2.

---

## 3.1. Structured Output (P0) — настройка LLM‑ноды

В P0 используется **плоская JSON‑схема Structured Output**, которая:

- соответствует минимальному формату ответа в `prompt.md` (§14)
- является подмножеством полной схемы из `cta.md`
- учитывает ограничения Flowise по вложенным объектам (nested objects)

**Плоские поля, которые должен возвращать LLM‑узел:**

- `answer` — текст ответа пользователю
- `ui_ctaIntent` — намерение по CTA (`"booking"` или `"none"`)
- `meta_stage` — стадия диалога (`"discovery" | "interest" | "ready" | ...`)
- `meta_confidence` — уверенность модели в классификации (число с точкой, например `0.6`)
- `flags_emotional` — эмоциональное состояние пользователя (boolean)
- `leadIntent` — режим записи для виджета:  
  `none | awaiting_name | awaiting_phone | complete`

**Требования к настройке LLM‑ноды в AgentFlow V2 (P0):**

- использовать JSON Structured Output с перечисленными плоскими ключами (String / Number / Boolean)
- промпт LLM‑ноды берётся из `prompt.md` (с учётом блока про формат ответа)
- модель обучается:
  - определять стадию диалога
  - классифицировать эмоциональное состояние
  - корректно устанавливать `leadIntent` при режиме записи
- в режиме записи (`leadIntent != "none"`) модель всегда возвращает `ui_ctaIntent = "none"`, чтобы кнопка CTA не показывалась

**Важно:**

- Сама **JSON‑схема и семантика полей** окончательно зафиксированы в `prompt.md` (§14) и `cta.md`.  
  Если они расходятся с этим разделом, приоритет у `prompt.md` / `cta.md`.
- Этот раздел описывает именно **настройку Flowise**, а не поведение фронта; логика виджета описана в `cta.md` и `backlog.md`.

---

## 4. Связь с другими документами

- **`bot.md`** — описывает общую архитектуру: VPS, Docker, nginx, backend, маршруты.  
  Flowise в `bot.md` рассматривается на уровне **роли в системе**, без деталей нод.

- **`logic.md`** — описывает **поведение бота, UX и диалоговые принципы**.  
  AgentFlow V2 в Flowise должен соответствовать этим принципам.

- **`cta.md`** — основной документ по архитектуре CTA и JSON‑схеме ответа.  
  Все поля Structured Output и бизнес‑правила CTA берутся отсюда.

- **`prompt.md`** — текст системного промпта и требования к Structured Output.  
  Его текст переносится в LLM‑ноду AgentFlow V2 без произвольных изменений.

- **`backlog.md`** — задачи по доработке Flowise (расширение схемы, настройки температур и т.д.).  
  При выполнении задач изменения должны быть отражены в `flowise.md` и/или `cta.md`/`prompt.md`,  
  если меняется контракт.

---

**Статус документа:** структура и принципы AgentFlow V2 (не Chatflow).  
По мере развития бота сюда можно добавить:
- список конкретных нод AgentFlow V2 и их типов
- важные параметры (temperature, maxTokens и т.п.)
- схемы для P1+ (расширенные CTA, офф‑топ, эмпатия и др.)


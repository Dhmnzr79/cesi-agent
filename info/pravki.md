1) prompt.md — критические правки поведения
1.1 Фикс: current_topics пуст ≠ “в базе нет информации”

Сделать:

Переписать правило (сейчас в духе “если current_topics пуст — в базе нет инфы”) на двухсценарное:

Контекст/результаты ретривера пустые → можно говорить “в базе нет информации по запросу” + предложить уточнить/админа.

Контекст есть, но current_topics пуст (reference-контент без ###) → отвечать по context, а в конце:

общий вопрос/мягкий CTA без перечисления подтем.

1.2 Сценарий 3b: “Всё по теме уже рассказано”

Сделать:

Добавить правило: если пользователь просит “ещё”, но в current_topics нет новых подтем/контекст исчерпан:

честно сказать “я рассказал всё, что есть в базе по этой теме”

дальше предложить: администратор/консультация или общий вопрос “что именно хотите уточнить” (без обещаний фактов вне базы).

1.3 Мультивопросы (2–4 вопроса в одном сообщении)

Сделать:

Добавить правило:

ответить на 1–2 ключевых вопроса структурно (нумерацией/списком),

остальное — через current_topics (если есть),

если current_topics пуст — общий уточняющий вопрос.

1.4 Анти-дословность RAG

Сделать:

Добавить правило: “пересказывай своими словами; не копируй длинными кусками; допустима 1 короткая фраза из базы, остальное — перефраз при сохранении смысла”.

1.5 Смягчить “обязательный вектор продолжения”

Сделать:

Оставить принцип “вести диалог дальше”, но добавить исключение:

при сильной тревоге/эмоциях/экстренных симптомах допускается завершение без вопроса, с мягким “если хотите — помогу дальше”.

Убедиться, что это не конфликтует с текущим правилом “не ставить точку”.

1.6 Жёсткий запрет на “общую стоматологию” вне базы (с разумным исключением)

Сделать:

Закрепить: без опоры на context запрещено давать медицинские советы/диагнозы/схемы лечения/лекарства/обещания результатов.

Разрешить только “навигацию”:

уточняющий вопрос,

предложение администратора/консультации,

безопасная оговорка “точно скажет врач после осмотра”.

2) rules.md — сценарные запреты и безопасные реакции
2.1 Экстренные случаи (“красные флаги”)

Сделать:

Добавить пункт: при признаках “кровотечение не останавливается / быстро растёт отёк / высокая температура / сильная аллергия / затруднение дыхания / резкое ухудшение после процедуры”:

не вести диагностику,

рекомендовать срочную помощь,

meta_shouldHandoff=true,

запросить контакт для связи администратора.

2.2 Перенос/отмена/подтверждение записи

Сделать:

Добавить пункт: бот не видит расписание и статус записей → не подтверждает/не переносит → перевод на администратора (meta_shouldHandoff=true) + запрос имени/телефона.

2.3 Жалобы/конфликты/претензии

Сделать:

Добавить краткое правило: не спорить, не оправдываться, не обещать компенсаций, переводить на администратора (meta_shouldHandoff=true) + запрос контакта.

2.4 Оффтоп: флуд/спам/политика/юмор

Сделать:

Уточнить формулировку, что “политика = оффтоп”.

Уточнить: если шутка + вопрос по делу в одном сообщении → игнорировать шутку и ответить по сути.

При повторе/эскалации → прекращать диалог / handoff при угрозах.

3) dialog-scenarios.md — добавить готовые сценарии (шаблоны ответов)

Добавить 4 сценария (в вашем стиле):

3.1 Экстренные симптомы / красные флаги

Шаблон короткий: серьёзность → срочная помощь → handoff → контакт.

3.2 Жалоба / конфликт / претензия

Сочувствие → цель помочь → администратор → контакт → handoff.

3.3 Перенос/отмена/подтверждение записи

“Не вижу расписание/статус” → администратор → контакт → handoff.

3.4 Мультивопрос

Ответ 1–2 пункта списком → предложение продолжить через current_topics или общий вопрос, если topics пуст.

4) Логика “услуга не оказывается” (унифицировать поведение)
4.1 Услуга “не подтверждена базой”

Сделать (в prompt/rules/scenarios — где удобнее):

Если пользователь спрашивает услугу и в базе нет прямого подтверждения, что клиника её оказывает:

не делать вывод “да/нет”,

говорить: “в базе нет подтверждения — уточнит администратор”,

meta_shouldHandoff=true + запрос контакта (или предложить консультацию).

4.2 Известные ограничения (дети/ОМС/страховки и т.п.)

Оставить как есть (у вас уже хорошо), но привести к единому стилю.

5) current-topics-mechanics.md / logic.md — синхронизация (без противоречий)

Сделать:

Проверить, что определения “нет контекста” vs “topics пуст, но контекст есть” совпадают с новым prompt.md.

Убедиться, что “обязательный вектор продолжения” не конфликтует с исключениями (emotional/urgent).

6) Мини Lead Card (на фронте) — самый минимальный вариант

Сделать:

Реализовать 2 поля на стороне UI/бекенда (не обязательно в Flowise):

stage: cold / warm / hot

handoff: true/false (соответствует meta_shouldHandoff)

Использование:

handoff=true → интерфейс предлагает контакт/связь с администратором

stage=hot → CTA “Записать?” (по вашим правилам leadIntent)

stage=warm/cold → мягкие подсказки/вопросы без давления

7) Набор тест-кейсов (QA после правок)

Сделать список ручных проверок (прогнать после внедрения):

Спам/флуд/политика → вежливо ограничивает, не втягивается.

Шутка + вопрос по делу → отвечает по делу.

Услуга не подтверждена базой → “нет подтверждения” + handoff.

Услуга есть, но инфы нет (контекст пуст) → честно “нет инфы” + уточнение/админ.

current_topics пуст, но контекст есть (reference) → НЕ говорит “инфы нет”, отвечает нормально.

“Расскажи ещё” при исчерпанных подтемах → “всё из базы рассказал” + админ/консультация.

Перенос/подтверждение записи → “не вижу расписание” + handoff.

Жалоба/агрессия → без спора + handoff.

Экстренные симптомы → срочно к врачу + handoff.

Мультивопрос → отвечает 1–2 пункта, остальное предлагает продолжить корректно.


-----

Не говори “в базе/контексте/ретривере”.
Вместо этого используй формулировки про точность: «чтобы ответить точно», «не хочу ошибиться», «есть нюансы».

Когда нет точного ответа или всё уже объяснено — один из двух ходов:

Уточнить 1 вопрос (самый важный для продолжения), или

Подключить администратора / предложить консультацию.

Избегай повторения одинаковых фраз:
если уже использовал формулировку в предыдущем сообщении, перефразируй (тот же смысл, другие слова).

Эти 3 строки дадут вариативность без “портянок” и сохранят контроль.
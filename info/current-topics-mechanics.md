# Механика current_topics

## 1. Откуда берутся current_topics

**Источник:** выход Retriever (RAG по md, формат Text with Metadata).

**Custom Function (extract-sections):**
- На вход: массив чанков с полями `text` и `metadata` (как минимум — имя файла / source).
- Действия:
  1. По каждому чанку ищет строки с заголовками `###` (регулярка).
  2. Игнорирует заголовки `### Коротко`.
  3. Собирает уникальные заголовки `###` по теме (файлу).
  4. Формирует строку: список заголовков через запятую, без повторов.
- На выход:
  - строка вида:  
    `Кому подходит, Почему выбирают, Сроки и ограничения`
- Обновление состояния:
  - записывает эту строку в `$flow.state.current_topics`.

**Важно:**
- Если ретривер ничего не вернул → функция возвращает пустую строку.
- Если файл reference‑типа без `###` (кроме «Коротко») → вклад этого файла в `current_topics` = 0.

---

## 2. Как LLM использует current_topics в промпте

В `prompt.md`:

- В системный промпт подставляется:  
  `{{ $flow.state.current_topics }}` как «список доступных подразделов по текущему запросу (через запятую)».
- Это **единственный разрешённый список** для предложений «рассказать подробнее про X».

**Жёсткие правила:**
- Запрещено:
  - предлагать продолжение по аспектам, которых нет в `current_topics`;
  - придумывать типичные стоматологические подтемы от себя (этапы, показания, стоимость и т.п.).
- Если `current_topics` не пуст:
  - в конце ответа нужно выбрать **одну** подходящую тему из этого списка, которая ещё не обсуждалась;
  - построить вектор продолжения только по ней.

---

## 3. Пустой current_topics — два сценария

### 3.1. Пусто, потому что нет релевантного контента

**Условия:**
- Ретривер не вернул ни одного чанка или вернул шум.
- Соответственно, Custom Function вернул пустую строку.

**Поведение:**
- Честно сообщить, что по запросу нет информации в базе.
- Предложить:
  - переформулировать вопрос
  - или обратиться к администратору / на консультацию.
- Вектор продолжения:
  - мягкий вопрос или handoff, без попытки «угадать» ответ.

### 3.2. Пусто, но контент есть (reference-файлы без `###`)

**Условия:**
- Ретривер вернул контент, но только из файлов без `###` (или только `### Коротко`).
- Custom Function не нашёл дополнительных `###` → список пуст.

**Поведение:**
- Построить ответ по имеющемуся контенту (один цельный блок, часто типа reference).
- Не предлагать конкретные подразделы («рассказать про этапы/стоимость/ограничения»), потому что их нет в `current_topics`.
- Вектор продолжения:
  - общий вопрос или предложение:
    - «Чем ещё могу помочь?»
    - «Есть ли ещё вопросы?»
    - «Подсказать, как записаться на консультацию?»

---

## 4. Memory Check — чтобы не повторять уже раскрытые разделы

**Цель:**
- Не предлагать в векторе продолжения те темы из `current_topics`, которые уже были подробно раскрыты в этой сессии.

**Механика (логическая, без доп. полей):**
- LLM смотрит:
  - историю сообщений в диалоге;
  - свои же предыдущие ответы и то, какие подразделы уже объяснял.
- При выборе следующей темы:
  - исключает заголовки из `current_topics`, которые уже были:
    - явно использованы как подтема ответа;
    - или уже предлагались и детально раскрывались.
- Если все темы из `current_topics` уже раскрыты:
  - больше не предлагает «рассказать подробнее про X»;
  - вместо этого:
    - общий вопрос / предложение помощи,
    - мягкий переход к консультации / администратору (если уместно).
  - Если пользователь при этом просит «ещё» / «подробнее» — честно сказать, что по этой теме всё рассказано; далее — администратор или «что именно уточнить» (см. prompt.md §4.1.1, сценарий «Всё по теме уже рассказано»).

---

## 5. Связь current_topics с JSON Structured Output

**Неявная связь:**
- `current_topics` **не попадает напрямую в JSON**.
- Он влияет на:
  - содержание поля `answer`;
  - формулировку вектора продолжения;
  - выбор темы для продолжения (по `current_topics`) vs общие вопросы.

**Связь с полями JSON:**
- `answer` — текст с предложением «Если хотите, могу рассказать про [ТЕМА из current_topics]».
- `ui_ctaIntent`:
  - остаётся `"none"`, когда речь про продолжение темы;
  - может быть `"booking"`, если в тексте есть прямое предложение записаться.
- `meta_stage`:
  - может сдвигаться вперёд по мере закрытия подтем из `current_topics`.
- `meta_shouldHandoff`:
  - при сложных/затянувшихся вопросах по одной и той же подтеме вместо бесконечного раскрытия.

---

## 6. Ограничения и договорённости

- Не расширять список тем для предложений за пределы `current_topics`.
- Заголовки в базе должны:
  - быть короткими (3–7 слов);
  - отражать реальную пользу/содержание блока;
  - не быть чисто техническими (чтобы формулировки предложений звучали естественно:
    «могу рассказать про [название]»).
- Один файл = одна тема:
  - чтобы `current_topics` всегда относился к одному смысловому контексту.

